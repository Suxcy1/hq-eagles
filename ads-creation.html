<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advertising Services</title>

    <link rel="apple-touch-icon" sizes="180x180" href="images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon_io/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicon_io/android-chrome-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="images/favicon_io/android-chrome-512.png">
    <link rel="manifest" href="images/favicon_io/site.webmanifest">


    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-storage-compat.js"></script>
    <script src="firebase.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        .ad-type-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .ad-type-card {
            padding: 20px;
            border: 2px solid #3498db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .ad-type-card.selected {
            background: #3498db;
            color: white;
        }

        .properties-container {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 20px 0;
        }

        .property-card {
            min-width: 250px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .property-card.selected {
            border-color: #2ecc71;
            background: #f0fff4;
        }

        .property-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 4px;
        }

        .calculation-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .coming-soon {
            opacity: 0.6;
            pointer-events: none;
        }



        .upload-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #f0f0f0;
            z-index: 9999;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: #27ae60;
            transition: width 0.3s ease;
        }

        .upload-text {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            display: none;
            z-index: 10000;
        }
    </style>
</head>

<body>
    <div class="ad-type-selector">
        <div class="ad-type-card" onclick="selectAdType('website')" id="websiteAdCard">
            <h3>Website Ads</h3>
            <p>₦1000 per property/day</p>
        </div>
        <div class="ad-type-card" onclick="selectAdType('facebook')" id="facebookAdCard">
            <h3>Facebook Ads</h3>
            <p>₦2000 per property/day</p>
        </div>
        <div class="ad-type-card coming-soon">
            <h3>Google Ads (Coming Soon)</h3>
        </div>
    </div>

    <div id="propertiesSection" style="display: none;">
        <h2>Select Properties</h2>
        <div class="properties-container" id="propertiesContainer"></div>

        <div class="calculation-section">
            <div>
                <label>Number of Days: </label>
                <input type="number" id="adDays" min="1" value="1" onchange="calculateTotal()">
            </div>

            <div style="margin: 20px 0;">
                <h3>Selected Properties: <span id="selectedCount">0</span></h3>
                <h3>Total Cost: ₦<span id="totalAmount">0</span></h3>
            </div>

            <button onclick="processPayment()"
                style="padding: 12px 24px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Proceed to Payment
            </button>
            <!-- <button onclick="processTest()"
                style="padding: 12px 24px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Proceed to Test
            </button> -->

            <!-- Progress Indicators -->
            <div class="upload-progress">
                <div class="progress-bar"></div>
            </div>
            <div class="upload-text">Saving your campaign...</div>
        </div>
    </div>

    <script>

        const database = firebase.database();

        let currentAdType = 'website';
        let selectedProperties = [];
        let selectedProperty = [];
        let pricePerProperty = 1000;

        function selectAdType(type) {
            // Load properties
            loadUserProperties();
            currentAdType = type;
            pricePerProperty = type === 'website' ? 1000 : 2000;

            // Update UI
            document.querySelectorAll('.ad-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`${type}AdCard`).classList.add('selected');

            // Show properties section
            document.getElementById('propertiesSection').style.display = 'block';

            
        }

        async function loadUserProperties() {
            const userId = firebase.auth().currentUser?.uid;
            if (!userId) {
                // alert('Please login first');
                return;
            }

            try {
                const snapshot = await database.ref(`Properties/${userId}`).orderByChild('meta/status').equalTo('Active').once('value');
                const properties = snapshot.val();
                renderProperties(properties);
            } catch (error) {
                console.error('Error loading properties:', error);
                alert('Error loading properties');
            }
        }

        function renderProperties(properties) {
            const container = document.getElementById('propertiesContainer');
            container.innerHTML = '';

            Object.entries(properties).forEach(([key, property]) => {
                const propertyDiv = document.createElement('div');
                // console.log(property);
                // console.log(key);


                // selectedProperty = [];
                // selectedProperty.push(property);
                propertyDiv.className = 'property-card';
                propertyDiv.innerHTML = `
                    <img src="${property.media.mainImageUrl}" class="property-image">
                    <h4>${property.details.title}</h4>
                    <p>₦${property.details.price.toLocaleString()}</p>
                `;

                // propertyDiv.onclick = () => togglePropertySelection(key, propertyDiv);

                propertyDiv.onclick = () => {
                    // 1️⃣ do something first
                    console.log('Property clicked:', key);
                    console.log(property);

                    selectedProperty.push(property);


                    // example: add a class
                    // propertyDiv.classList.add('clicked');

                    // example: validation / condition
                    if (!key) return;

                    // 2️⃣ then call your function
                    togglePropertySelection(key, propertyDiv);
                };



                container.appendChild(propertyDiv);
            });
        }

        function togglePropertySelection(propertyId, element) {
            const index = selectedProperties.indexOf(propertyId);
            if (index === -1) {
                selectedProperties.push(propertyId);
                element.classList.add('selected');
            } else {
                selectedProperties.splice(index, 1);
                element.classList.remove('selected');
            }

            document.getElementById('selectedCount').textContent = selectedProperties.length;
            calculateTotal();
        }

        function calculateTotal() {
            const days = parseInt(document.getElementById('adDays').value) || 1;
            const total = selectedProperties.length * days * pricePerProperty;
            document.getElementById('totalAmount').textContent = total.toLocaleString();
        }

        function processPayment() {
            if (selectedProperty.length === 0) {
                alert('Please select at least one property');
                return;
            }

            const days = parseInt(document.getElementById('adDays').value);
            const totalAmount = selectedProperties.length * days * pricePerProperty;

            const handler = PaystackPop.setup({
                key: 'pk_test_3af7f6c37cdd5d6865ecf49f6bccff13cbb739fe',
                email: firebase.auth().currentUser.email,
                amount: totalAmount * 100, // Convert to kobo
                currency: 'NGN',
                metadata: {
                    ad_type: currentAdType,
                    properties: selectedProperties.join(','),
                    days: days
                },
                callback: function (response) {
                    handlePaymentSuccess(response);
                },
                onClose: function () {
                    alert('Payment cancelled');
                }
            });
            handler.openIframe();
        }
        async function processTest() {
            alert("Testing in process")

            if (selectedProperty.length === 0) {
                alert('Please select at least one property');
                return;
            }
            console.log(selectedProperty);
            console.log(selectedProperties);


            for (const property of selectedProperty) {
                console.log(property);

                const name = property.details.title || ''
                const description = property.details.description || ''
                const price = property.details.price || ''
                const currency = property.details.currency || ''
                const home_listing_id = String(property.meta.pushKey)
                const neighbourhood = property.location.street
                const state = property.location.state
                const city = property.location.city
                const address = property.location.street
                const status = property.status || 'pause'
                const availability = property.availability || 'for_sale'
                const condition = property.condition || 'new'
                const url = property.url || 'eagleshub.web.app'


                // safe handling of property.media and its fields
                const media = (property && property.media) ? property.media : {};

                // ensure both variables are arrays (handle single-string values too)
                const additional_images = Array.isArray(media.decImage)
                    ? media.decImage
                    : (media.decImage ? [media.decImage] : []);

                const images = Array.isArray(media.mainImageUrl)
                    ? media.mainImageUrl
                    : (media.mainImageUrl ? [media.mainImageUrl] : []);

                // pick a single main image if you need one
                const image = images[0] || additional_images[0] || null;

                // combine, filter out falsy values, join with semicolon
                const additional_image_link = [...additional_images, ...images].filter(Boolean).join(';');


                const payload = {
                    name: name || '',
                    description: description || '',
                    price: price || '',
                    currency: currency || '',
                    home_listing_id: home_listing_id,
                    neighbourhood: neighbourhood,
                    state: state,
                    city: city,
                    address: address,
                    additional_image_link: additional_image_link,
                    status: status || '',
                    availability: availability || '',
                    condition: condition || '',
                    url: url || '',
                    image: image
                };

                console.log(payload);

                try {
                    const response = await fetch('http://localhost:4000/forward', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    // Parse the response
                    const data = await response.json();

                    if (response.ok) {
                        console.log("✅ Feed sent successfully:", data);
                        alert("Feeds uploaded successfully!");
                    } else {
                        console.error("❌ Error from server:", data);
                        alert("Error: " + (data.error || "Something went wrong"));
                    }
                } catch (err) {
                    console.error("⚠️ Request failed:", err);
                    alert("Network error — check your internet or server connection");
                }
            }


        }






        // Function to call your Node.js server
        async function sendFeedToServer(productFeeds) {
            try {
                const response = await fetch('https://your-server.com/api/createFeed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productFeeds)
                });

                // Parse the response
                const data = await response.json();

                if (response.ok) {
                    console.log("✅ Feed sent successfully:", data);
                    alert("Feeds uploaded successfully!");
                } else {
                    console.error("❌ Error from server:", data);
                    alert("Error: " + (data.error || "Something went wrong"));
                }
            } catch (err) {
                console.error("⚠️ Request failed:", err);
                alert("Network error — check your internet or server connection");
            }
        }


        // async function handlePaymentSuccess(paymentResponse) {
        // try {
        // const userId = firebase.auth().currentUser.uid;
        // const adCampaign = {
        // type: currentAdType,
        // properties: selectedProperties,
        // days: parseInt(document.getElementById('adDays').value),
        // amount: selectedProperties.length * pricePerProperty * parseInt(document.getElementById('adDays').value),
        // paymentReference: paymentResponse.reference,
        // status: 'Active',
        // startDate: new Date(),
        // endDate: new Date(Date.now() + (parseInt(document.getElementById('adDays').value) * 86400000)).toISOString()
        // };

        // // Save to Firebase
        // // await database.ref(`AdCampaigns/${userId}/${paymentResponse.reference}`).set(adCampaign);
        // console.log(adCampaign);


        // alert('Payment successful! Your ads are now active.');
        // // Redirect or update UI as needed
        // } catch (error) {
        // console.error('Error saving campaign:', error);
        // alert('Error processing payment. Please contact support.');
        // }
        // }

        // async function handlePaymentSuccess(paymentResponse) {
        // try {
        // const userId = firebase.auth().currentUser.uid;
        // const db = firebase.database();

        // const adCampaign = {
        // type: currentAdType,
        // properties: selectedProperties,
        // days: parseInt(document.getElementById('adDays').value),
        // cost: selectedProperties.length * pricePerProperty * parseInt(document.getElementById('adDays').value),
        // paymentReference: paymentResponse.reference,
        // status: 'active',
        // startDate: new Date().toISOString(),
        // endDate: new Date(Date.now() + (parseInt(document.getElementById('adDays').value) * 86400000)).toISOString()
        // };

        // // Get database reference based on ad type
        // let campaignRef;
        // if (currentAdType === 'website') {
        // // Website ads don't use pushkey - overwrite existing
        // campaignRef = db.ref(`subscriptions/AdCampaigns/website`);
        // } else {
        // // Other ads use pushkey
        // campaignRef = db.ref(`subscriptions/AdCampaigns/${currentAdType}`).push();
        // }

        // // Update database
        // await campaignRef.set(adCampaign);

        // // Update properties with ad status
        // const updates = {};
        // selectedProperties.forEach(propertyId => {
        // updates[`Properties/${userId}/${propertyId}/subscription/adCampaigns/${currentAdType}`] = {
        // status: 'active',
        // endDate: adCampaign.endDate
        // };
        // });

        // await db.ref().update(updates);

        // alert('Payment successful! Ads are now active.');
        // window.location.href = '/confirmation'; // Redirect

        // } catch (error) {
        // console.error('Error saving campaign:', error);
        // alert('Error processing payment. Please contact support.');
        // }
        // }

        // Initialize Firebase Auth (Add your auth logic here)
        // firebase.auth().onAuthStateChanged(user => {
        // if (user) {
        // // User is logged in
        // } else {
        // window.location.href = 'index.html'; // Redirect to login
        // }
        // });




        // Updated Payment Handler with Progress
        async function handlePaymentSuccess(paymentResponse) {
            try {
                // Show upload progress
                const progressBar = document.querySelector('.progress-bar');
                const uploadText = document.querySelector('.upload-text');
                document.querySelector('.upload-progress').style.display = 'block';
                uploadText.style.display = 'block';

                const userId = firebase.auth().currentUser.uid;
                const isWebsite = currentAdType === 'website';
                const days = parseInt(document.getElementById('adDays').value);

                // Process each property
                let processed = 0;
                const total = selectedProperties.length;

                for (const propertyId of selectedProperties) {
                    // Update progress
                    processed++;
                    progressBar.style.width = `${(processed / total) * 100}%`;
                    uploadText.textContent = `Saving ${processed}/${total} properties`;

                    // Base campaign data
                    const campaignData = {
                        paymentReference: paymentResponse.reference,
                        status: 'active',
                        days: days,
                        cost: days * (isWebsite ? 1000 : 2000),
                        createdAt: Date.now()
                    };

                    // Add timing based on ad type
                    if (isWebsite) {
                        campaignData.startTime = Date.now();
                        campaignData.endTime = Date.now() + (days * 86400000);
                    } else {
                        const endDate = new Date(Date.now() + (days * 86400000));
                        campaignData.endTime = endDate.toLocaleDateString('en-US', {
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }


                    // Property ad campaign path
                    const propertyCampaignPath = `Properties/${userId}/${propertyId}/subscription/adsCampaigns/${currentAdType}`;

                    // Website ads special handling
                    if (isWebsite) {
                        // 1. Save to property path (overwrite)
                        await database.ref(propertyCampaignPath).set(campaignData);

                        // 2. Save to subscriptions with new pushkey
                        const subRef = database.ref(`Subscription/${propertyId}`);
                        await subRef.set({
                            userId: userId,
                            propertyId: propertyId
                        });
                    } else {
                        // Facebook ads - save with pushkey
                        const fbRef = database.ref(propertyCampaignPath);
                        await fbRef.set(campaignData);
                        processTest();
                    }
                }

                // Hide progress
                setTimeout(() => {
                    document.querySelector('.upload-progress').style.display = 'none';
                    uploadText.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 1000);

                alert('Campaign activation successful!');
                window.location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert('Activation failed: ' + error.message);
            }
        }
    </script>
</body>

</html>