<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Analytics</title>
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon_io/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicon_io/android-chrome-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="images/favicon_io/android-chrome-512.png">
    <link rel="manifest" href="images/favicon_io/site.webmanifest">

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background: #f8f9fa;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background);
            color: var(--text-color);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .property-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .property-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary-color);
            width: var(--progress);
        }

        .comments-scroll {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding: 1rem 0;
        }

        .comment-card {
            flex: 0 0 300px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .search-terms {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .search-term {
            background: var(--secondary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .star-rating {
            color: gold;
            font-size: 1.2rem;
        }

        .app {
            min-height: 30vh;
            display: grid;
            place-items: center;
            margin-top: 2rem;
        }

        .rating {
            width: 75vw;
            display: flex;
            align-items: center;
            column-gap: 1rem;
        }

        .rating_average {
            width: 30%;
            background-color: var(--secondary);
            padding: 1rem;
            border-radius: .8rem;
            text-align: center;
            color: var(--text-color);
        }

        .rating_average p {
            letter-spacing: .1rem;
        }

        .rating_average h1 {
            font-size: 3rem;
        }

        .star_out {
            position: relative;
            font-size: 1.2rem;
            display: inline-block;
        }

        .star_out::before {
            content: "★★★★★";
            color: #fff8;
        }

        .star_inner {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            overflow: hidden;
        }

        .star_inner::before {
            content: "★★★★★";
            color: gold;
        }

        .rating_progress {
            width: 70%;
        }

        .rating_progress_value {
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-evenly;
            column-gap: 1rem;
        }

        .progress {
            flex: 1 1 0;
            height: .5rem;
            background-color: #ff02;
            border-radius: .5rem;
        }

        .bar {
            height: 100%;
            background-color: gold;
            border-radius: .5rem;
        }

        /* .reviewContainer {
            margin: 1rem;
        }

        .review {
            margin: 1rem;
            background-color: #fff;
            border-radius: .45rem;
            padding: 1rem;
        } */

        .reviewContainer {
            margin: 1rem;
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding-bottom: 1rem;
        }

        .review {
            flex: 0 0 300px;
            background-color: #fff;
            border-radius: .45rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filled {
            color: gold;
        }

        .unfilled {
            color: #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Property Header -->
        <div class="property-header">
            <img id="propertyImage" class="property-image" alt="Property Image">
            <h1 id="propertyTitle"></h1>
        </div>

        <!-- Main Analytics -->
        <div class="analytics-grid">
            <div class="metric-card">
                <h3>Basic Information</h3>
                <p id="propertyName"></p>
                <p>Created: <span id="createdAt"></span></p>
                <p>Last Updated: <span id="updatedAt"></span></p>
            </div>

            <div class="metric-card">
                <h3>Views</h3>
                <h2 id="totalViews">0</h2>
            </div>

            <div class="app">
                <div class="rating">
                    <div class="rating_average">
                        <h1>0.0</h1>
                        <div class="star_out">
                            <div class="star_inner"></div>
                        </div>
                        <p>0</p>
                    </div>
                    <div class="rating_progress"></div>
                </div>
            </div>

            <h3>Customer Reviews</h3>
            <div class="reviewContainer"></div>
        </div>

        <!-- Search Terms -->
        <div class="metric-card">
            <h3>Search Keywords</h3>
            <div class="search-terms" id="searchTerms"></div>
        </div>


        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
        <script src="firebase.js"></script>

        <script>

            const database = firebase.database();
            const auth = firebase.auth();

            let currentUser = null;
            let propertyId = null;

            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    propertyId = new URLSearchParams(window.location.search).get('propertyId');
                    if (!propertyId) throw new Error('Missing property ID');

                    currentUser = await authenticateUser();
                    const propertyData = await loadPropertyData();
                    await loadAnalyticsData(propertyData);
                } catch (error) {
                    handleError(error.message);
                }
            });


            document.addEventListener('DOMContentLoaded', async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('propertyId');
                const user = await authenticateUser();

                if (!propertyId || !user) return;

                const starCount = [
                    { star: 5, count: 0 },
                    { star: 4, count: 0 },
                    { star: 3, count: 0 },
                    { star: 2, count: 0 },
                    { star: 1, count: 0 }
                ];

                // Fetch clicks
                const clicksRef = database.ref(`Properties/${currentUser.uid}/${propertyId}/conversion/clicks`);
                const clicksSnapshot = await clicksRef.once('value');
                const totalClicks = clicksSnapshot.exists() ? clicksSnapshot.numChildren() : 0;

                // Fetch ratings and comments
                const ratesRef = database.ref(`Properties/${currentUser.uid}/${propertyId}/conversion/rates/`);
                const ratesSnapshot = await ratesRef.once('value');

                if (ratesSnapshot.exists()) {
                    ratesSnapshot.forEach(rateSnapshot => {
                        // console.log(rateSnapshot.val());

                        const rate = rateSnapshot.val();
                        const rates = Number(rate.rating)
                        const starIndex = starCount.findIndex(s => s.star === rates);

                        if (starIndex !== -1) starCount[starIndex].count++;
                    });
                }

                // Calculate totals
                let totalRating = 0, ratingSum = 0;
                starCount.forEach(rating => {
                    totalRating += rating.count;
                    ratingSum += rating.count * rating.star;
                });

                // Update UI
                const averageRating = totalRating > 0 ? (ratingSum / totalRating).toFixed(1) : 0;
                document.querySelector('.rating_average h1').textContent = averageRating;
                document.querySelector('.rating_average p').textContent = totalRating.toLocaleString();
                document.querySelector('.star_inner').style.width = `${(averageRating / 5) * 100}%`;

                // Add progress bars
                const ratingProgress = document.querySelector('.rating_progress');
                starCount.forEach(rating => {
                    const width = totalRating > 0 ? (rating.count / totalRating) * 100 : 0;
                    ratingProgress.innerHTML += `
                    <div class="rating_progress_value">
                        <p>${rating.star} <span class="star">★</span></p>
                        <div class="progress">
                            <div class="bar" style="width: ${width}%"></div>
                        </div>
                        <p>${rating.count.toLocaleString()}</p>
                    </div>
                `;
                });

                // Add comments
                const reviewContainer = document.querySelector('.reviewContainer');
                if (ratesSnapshot.exists()) {
                    ratesSnapshot.forEach(rateSnapshot => {
                        const rate = rateSnapshot.val();
                        const comment = rate.comment || "No comment provided"
                        if (comment) {
                            const stars = '★'.repeat(rate.rating) + '☆'.repeat(5 - rate.rating);
                            reviewContainer.innerHTML += `
                            <div class="review">
                                <div class="star_rating">${stars}</div>
                                <h4>${comment}</h4>
                                <small>${formatDate(rate.timestamp)}</small>
                            </div>
                        `;
                        }
                    });
                }
            });

            function authenticateUser() {
                return new Promise((resolve, reject) => {
                    auth.onAuthStateChanged(user => {
                        if (user) resolve(user);
                        else {
                            window.location.href = '/login.html';
                            reject(new Error('User not authenticated'));
                        }
                    });
                });
            }

            async function loadPropertyData() {
                const ref = database.ref(`Properties/${currentUser.uid}/${propertyId}`);
                const snapshot = await ref.once('value');
                if (!snapshot.exists()) throw new Error('Property not found');

                const data = snapshot.val();
                renderPropertyInfo(data);
                return data;
            }

            function renderPropertyInfo(property) {
                document.getElementById('propertyImage').src = property.media.mainImageUrl;
                document.getElementById('propertyTitle').textContent = property.details.title;
                document.getElementById('propertyName').textContent = property.details.title;
                document.getElementById('createdAt').textContent = formatDate(property.meta.createdAt);
                document.getElementById('updatedAt').textContent = formatDate(property.meta.updatedAt);
            }

            async function loadAnalyticsData(property) {
                const [views, ratings, comments, searches] = await Promise.all([
                    fetchNodeCount(`Properties/${currentUser.uid}/${propertyId}/conversion/clicks`),
                    fetchRatings(),
                    fetchComments(),
                    fetchSearchTerms(property.meta.pushKey)
                ]);

                renderViews(views);
                // renderRatings(ratings);
                // renderComments(comments);
                renderSearchTerms(searches);
            }

            async function fetchNodeCount(path) {
                const snapshot = await database.ref(path).once('value');
                return snapshot.exists() ? snapshot.numChildren() : 0;
            }

            async function fetchRatings() {
                const ratingsRef = database.ref(`Properties/${currentUser.uid}/${propertyId}/conversion/rates`);
                const snapshot = await ratingsRef.once('value');

                const ratings = { total: 0, sum: 0, counts: [0, 0, 0, 0, 0] };
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const rating = child.val();
                        // console.log(rating);

                        ratings.total++;
                        ratings.sum += rating;
                        ratings.counts[5 - rating.rating]++;
                    });
                } console.log(ratings);

                return ratings;
            }

            async function fetchComments() {
                const commentsRef = database.ref(`Properties/${currentUser.uid}/${propertyId}/conversion/comments`);
                const snapshot = await commentsRef.once('value');
                return snapshot.exists() ? snapshot.val() : {};
            }

            async function fetchSearchTerms(pushKey) {
                const searchRef = database.ref(`Properties/${currentUser.uid}/${propertyId}/conversion/search`);
                const snapshot = await searchRef.once('value');
                return snapshot.exists() ? snapshot.val() : {};
            }

            function renderViews(count) {
                document.getElementById('totalViews').textContent = count.toLocaleString();
            }

            function renderRatings({ total, sum, counts }) {
                const average = total > 0 ? (sum / total).toFixed(1) : 0;
                document.getElementById('averageRating').textContent = average;

                const progressHTML = counts.map((count, index) => {
                    const rating = 5 - index;
                    const width = total > 0 ? (count / total) * 100 : 0;

                    return `<div class="progress-bar">
                    <div class="progress-fill" style="width: ${width}%"></div>
                </div>`;
                }).join('');

                document.getElementById('ratingProgress').innerHTML = progressHTML;
            }

            function renderComments(comments) {
                const container = document.getElementById('commentsContainer');
                container.innerHTML = Object.values(comments).map(comment => `
                <div class="comment-card">
                    <div class="star-rating">
                        ${'★'.repeat(comment.rating)}${'☆'.repeat(5 - comment.rating)}
                    </div>
                    <p>${comment.text || 'No comment provided'}</p>
                    <small>${formatDate(comment.timestamp)}</small>
                </div>
            `).join('');
            }

            function renderSearchTerms(terms) {
                const container = document.getElementById('searchTerms');
                container.innerHTML = Object.entries(terms).map(([term, count]) => `
                <div class="search-term">
                    ${term} (${count})
                </div>
            `).join('');
            }

            function formatDate(timestamp) {
                const date = new Date(timestamp);
                return new Intl.DateTimeFormat('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).format(date);
            }

            function handleError(message) {
                alert(message);
                window.location.href = '/';
            }
        </script>
</body>

</html>