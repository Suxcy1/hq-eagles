<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Listings</title>

    <link rel="apple-touch-icon" sizes="180x180" href="images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon_io/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicon_io/android-chrome-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="images/favicon_io/android-chrome-512.png">
    <link rel="manifest" href="images/favicon_io/site.webmanifest">
    <style>
        /* CSS Variables for maintainability */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #004E89;
            ;
            --success-color: #27ae60;
            --warning-color: #FF6B35;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f8f9fa;
        }

        /* Property list container */
        .property-list {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Property card styling */
        .property-card {
            display: flex;
            flex-direction: column;
            background: white;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .hide {
            display: none !important;
        }

        @media (min-width: 768px) {
            .property-card {
                flex-direction: row;
            }
        }

        /* Image section */
        .property-image-container {
            flex: 0 0 100%;
            max-height: 250px;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .property-image-container {
                flex: 0 0 300px;
                max-height: none;
            }
        }

        .property-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            aspect-ratio: 16/9;
        }

        /* Content section */
        .property-content {
            padding: 1.5rem;
            flex: 1;
        }

        .property-title {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--primary-color);
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .property-price {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--success-color);
            margin-bottom: 1.5rem;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: opacity 0.2s ease;
        }

        .action-button:hover {
            opacity: 0.9;
        }

        .analytics-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .edit-btn {
            background-color: var(--warning-color);
            color: black;
        }

        /* Loading and empty states */
        .status-message {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #ddd;
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status-btn {
            background-color: #f39c12;
            color: white;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
    </style>
</head>

<body>
    <main class="property-list" id="propertyList">
        <div class="status-message">
            <div class="loading"></div>
            <p>Loading properties...</p>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
    <script src="firebase.js"></script>

    <script>

        const database = firebase.database();
        const auth = firebase.auth();

        // State management
        let currentUser = null;
        let currentStatus = null;
        // 4. Filter and adjust properties according to plan
        let activeCount = 0;

        // DOM Elements
        const propertyList = document.getElementById('propertyList');

        // Initialize application
        document.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            try {
                currentStatus = getStatusFromURL();
                if (!currentStatus) handleError('Missing status parameter');

                currentUser = await authenticateUser();
                const properties = await fetchProperties();
                renderProperties(properties);
            } catch (error) {
                handleError(error.message);
            }
        }

        function getStatusFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('status');
        }

        function authenticateUser() {
            return new Promise((resolve, reject) => {
                auth.onAuthStateChanged(user => {
                    if (user) resolve(user);
                    else {
                        window.location.href = '/login.html';
                        reject(new Error('User not authenticated'));
                    }
                });
            });
        }

        async function fetchProperties() {
            try {
                const userRef = database.ref(`Properties/${currentUser.uid}`);
                const snapshot = await userRef.once('value');
                const properties = [];

                snapshot.forEach(childSnapshot => {
                    const property = childSnapshot.val();
                    if (property.meta.status === currentStatus) {
                        properties.push(property);
                    }
                    if (property.meta.status === "Active") {
                        activeCount++
                    }
                });

                return properties;
            } catch (error) {
                throw new Error('Failed to fetch properties');
            }
        }

        function renderProperties(properties) {
            propertyList.innerHTML = '';

            if (properties.length === 0) {
                propertyList.innerHTML = `
                    <div class="status-message">
                        No properties found with status: ${currentStatus}
                    </div>
                `;
                return;
            }

            properties.forEach(property => {
                const card = createPropertyCard(property);
                propertyList.appendChild(card);
            });
        }

        // function createPropertyCard(property) {
        //     const card = document.createElement('article');
        //     card.className = 'property-card';

        //     card.innerHTML = `
        //         <div class="property-image-container">
        //             <img 
        //                 src="${property.media.mainImageUrl}" 
        //                 class="property-image" 
        //                 alt="${property.details.title}"
        //                 loading="lazy"
        //             >
        //         </div>
        //         <div class="property-content">
        //             <h2 class="property-title">${property.details.title}</h2>
        //             <p class="property-price">
        //                 ${property.details.currency} ${property.details.price.toLocaleString()}
        //             </p>
        //             <div class="action-buttons">
        //                 <button 
        //                     class="action-button analytics-btn"
        //                     aria-label="View analytics for ${property.details.title}"
        //                     onclick="viewAnalytics('${property.meta.pushKey}')"
        //                 >
        //                     <span class="button-text">Analytics</span>
        //                 </button>
        //                 <button 
        //                     class="action-button edit-btn"
        //                     aria-label="Edit ${property.details.title}"
        //                     onclick="editProperty('${property.meta.pushKey}')"
        //                 >
        //                     <span class="button-text">Edit</span>
        //                 </button>
        //             </div>
        //         </div>
        //     `;

        //     return card;
        // }


        function createPropertyCard(property) {
            const card = document.createElement('article');
            card.className = 'property-card';

            const status = property.meta.status.toLowerCase();

            card.innerHTML = `
                <div class="property-image-container">
                    <img 
                        src="${property.media.mainImageUrl}" 
                        class="property-image" 
                        alt="${property.details.title}"
                        loading="lazy"
                    >
                </div>
                <div class="property-content">
                    <h2 class="property-title">${property.details.title}</h2>
                    <p class="property-price">
                        ${property.details.currency} ${property.details.price.toLocaleString()}
                    </p>
                    <div class="action-buttons">
                        <button 
                            class="action-button analytics-btn"
                            aria-label="View analytics for ${property.details.title}"
                            onclick="viewAnalytics('${property.meta.pushKey}')"
                        >
                            <span class="button-text">Analytics</span>
                        </button>
                        <button 
                            class="action-button edit-btn"
                            aria-label="Edit ${property.details.title}"
                            onclick="editProperty('${property.meta.pushKey}')"
                        >
                            <span class="button-text">Edit</span>
                        </button>

                        <button 
                            class="action-button review-btn"
                            aria-label="Edit ${property.details.title}"
                            onclick="reviwProperty('${property.meta.pushKey}')"
                        >
                            <span class="button-text">Review</span>
                        </button>
                        
                        <button 
                            class="action-button status-btn"
                            aria-label="Change status of ${property.details.title}"
                            onclick="changeStatus('${property.meta.pushKey}')"
                        >
                            <span class="button-text">Status</span>
                        </button>
                        <button 
                            class="action-button delete-btn"
                            id="delete-btn"
                            aria-label="Delete ${property.details.title}"
                            onclick="deleteProperty('${property.meta.pushKey}')"
                        >
                            <span class="button-text">Delete</span>
                        </button>
                    </div>
                </div>
            `;

            const btustatus = card.querySelector(".status-btn")
            const btuEdit = card.querySelector(".edit-btn")
            const btuDelete = card.querySelector(".delete-btn")
            const btuAnalytics = card.querySelector(".analytics-btn")
            const btuReview = card.querySelector(".review-btn")

            switch (status) {
                case "active":
                    if (btuEdit) btuEdit.classList.add("hide")
                    if (btuDelete) btuDelete.classList.add("hide")
                    if (btuReview) btuReview.classList.add("hide")
                    break;
                case "sold":
                    if (btuEdit) btuEdit.classList.add("hide")
                    if (btuReview) btuReview.classList.add("hide")
                    break;
                case "review":
                    if (btustatus) btustatus.classList.add("hide")
                    if (btuAnalytics) btuAnalytics.classList.add("hide")
                    break;
                case "cancel":
                    if (btustatus) btustatus.classList.add("hide")
                    if (btuAnalytics) btuAnalytics.classList.add("hide")
                    break;
                case "rejected":
                    if (btustatus) btustatus.classList.add("hide")
                    if (btuAnalytics) btuAnalytics.classList.add("hide")
                    if (btuEdit) btuEdit.classList.add("hide")
                    if (btuReview) btuReview.classList.add("hide")
                    break;

                default:
                    if (btustatus) btustatus.classList.remove("hide")
                    if (btuAnalytics) btuAnalytics.classList.remove("hide")
                    if (btuEdit) btuEdit.classList.remove("hide")
                    if (btuDelete) btuDelete.classList.remove("hide")
                    if (btuReview) btuReview.classList.add("hide")
                    break;
            }

            return card;
        }

        function handleError(message) {
            console.error(message);
            propertyList.innerHTML = `
                <div class="status-message">
                    ${message}. Please try again later.
                </div>
            `;
        }

        // Global functions for button actions
        window.viewAnalytics = function (pushKey) {
            window.location.href = `analytics.html?propertyId=${pushKey}`;
        }

        window.editProperty = function (pushKey) {
            window.location.href = `edit-property.html?propertyId=${pushKey}`;
        }

        window.reviwProperty = function (pushKey) {
            window.location.href = `propertyVerification.html?key=${pushKey}`;
        }

        // Add these new functions
        async function changeStatus(pushKey) {
            // 2. Check plan from localStorage
            const plan = sessionStorage.getItem("plan")?.toLowerCase() || "starter";
            // 3. Define plan limits
            const planLimits = {
                starter: 1,
                profession: 7,
                business: 15,
                enterprise: Infinity
            };

            const allowedUploads = planLimits[plan] ?? 1;

            if (activeCount >= allowedUploads) {
                alert(`You have reached your plan limit of ${allowedUploads} active properties.`);
                return;
            }
            const newStatus = prompt('Enter new status (Active, InActive, Sold):');
            if (['Active', 'InActive', 'Sold'].includes(newStatus)) {
                try {
                    await database.ref(`Properties/${currentUser.uid}/${pushKey}/meta/status`)
                        .set(newStatus);
                    alert('Status updated successfully');
                    location.reload();
                } catch (error) {
                    alert('Error updating status: ' + error.message);
                }
            } else {
                alert('Invalid status value');
            }
        }

        async function deleteProperty(pushKey) {
            if (confirm('Are you sure you want to delete this property?')) {
                try {
                    // Delete from Realtime Database
                    await database.ref(`Properties/${currentUser.uid}/${pushKey}`).remove();

                    // Delete from Firestore
                    await firestore.doc(`Properties/${currentUser.uid}/${pushKey}`).delete();

                    alert('Property deleted successfully');
                    location.reload();
                } catch (error) {
                    alert('Error deleting property: ' + error.message);
                }
            }
        }
    </script>
</body>

</html>