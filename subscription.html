<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Plans</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>


    <link rel="apple-touch-icon" sizes="180x180" href="images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon_io/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicon_io/android-chrome-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="images/favicon_io/android-chrome-512.png">
    <link rel="manifest" href="images/favicon_io/site.webmanifest">
    <!-- Meta Pixel Code -->
    <script>
        !function (f, b, e, v, n, t, s) {
            if (f.fbq) return; n = f.fbq = function () {
                n.callMethod ?
                    n.callMethod.apply(n, arguments) : n.queue.push(arguments)
            };
            if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0';
            n.queue = []; t = b.createElement(e); t.async = !0;
            t.src = v; s = b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t, s)
        }(window, document, 'script',
            'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '645771161540733');
        fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
            src="https://www.facebook.com/tr?id=645771161540733&ev=PageView&noscript=1" /></noscript>
    <!-- End Meta Pixel Code -->

    <!-- Add Paystack SDK -->

    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-storage-compat.js"></script>
    <script src="firebase.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .plan {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .plan h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .price {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .features {
            list-style: none;
            padding: 0;
            margin-bottom: 25px;
            text-align: left;
        }

        .features li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }

        .features li:before {
            content: "✓";
            color: #27ae60;
            position: absolute;
            left: 0;
        }

        .subscribe-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .subscribe-btn:hover {
            background-color: #2980b9;
        }

        .free {
            border: 2px solid #2ecc71;
        }

        .silver {
            border: 2px solid #95a5a6;
        }

        .premium {
            border: 2px solid #f1c40f;
        }

        .gold {
            border: 2px solid #e67e22;
        }

        .badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* Previous CSS styles remain the same */
        .ad-services {
            margin-top: 50px;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .coming-soon {
            background: #f39c12;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }

        .ad-service {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e74c3c;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="subscription-plans">
        <!-- Free Plan 
        <div class="plan free" data-plan="free">
            <h2>Starter Subscription</h2>
            <div class="price">₦0/month</div>
            <ul class="features">
                <li>1 Property Upload</li>
                <li>No Social Media Ads</li>
                <li>Basic Support</li>
            </ul>
            <button id="btn-free" class="subscribe-btn" onclick="initializePayment('starter', 0)">Start Free</button>
        </div>
-->


        <!-- Silver Plan -->
        <div class="plan silver" data-plan="trial">
            <h2>Trial Subscription</h2>
            <div class="price">Free</div>
            <ul class="features">
                <li>7 Property Uploads</li>

                <li>Priority Support</li>
            </ul>
            <button id="btn-silver" class="subscribe-btn" onclick="initializePayment('trial', 0)">Choose
                Trial Plan</button>
        </div>

        <div class="plan silver" data-plan="starter ">
            <h2>Starter Subscription</h2>
            <div class="price">₦6,000/month</div>
            <ul class="features">
                <li>10 Property Uploads</li>
                <li>Priority Support</li>
            </ul>
            <button id="btn-silver" class="subscribe-btn" onclick="initializePayment('starter', 60000)">Choose
                Starter Plan</button>
        </div>
        <!-- Silver Plan -->
        <div class="plan silver" data-plan="professional">
            <h2>Professional Subscription</h2>
            <div class="price">₦15,000/month</div>
            <ul class="features">
                <li>10 Property Uploads</li>
                <li>2 Website Ads (15 days)</li>
                <li>2 Social Media Ads (10 days)</li>
                <li>Priority Support</li>
            </ul>
            <button id="btn-silver" class="subscribe-btn" onclick="initializePayment('professional', 1250000)">Choose
                Professional Plan</button>
        </div>

        <!-- Premium Plan -->
        <div class="plan premium" data-plan="business">
            <h2>Business Subscription</h2>
            <div class="price">₦28,000/month</div>
            <ul class="features">
                <li>120 Property Uploads</li>
                <li>5 Website Ads (15 days)</li>
                <li>5 Social Media Ads (10 days)</li>
                <li>24/7 Support</li>
            </ul>
            <button id="btn-premium" class="subscribe-btn" onclick="initializePayment('business', 2500000)">Choose
                Business</button>
        </div>

        <!-- Gold Plan -->
        <div class="plan gold" data-plan="enterprise">
            <h2>Enterprise Subscription</h2>
            <div class="price">₦60,000/month</div>
            <ul class="features">
                <li>Unlimited Property Uploads</li>
                <li>5 Website Ads (30 days)</li>
                <li>5 Social Media Ads (10 days)</li>
                <li>5 Google Ads (10 days)</li>
                <li>VIP Support</li>
                <li>Featured Listings</li>
            </ul>
            <button id="btn-gold" class="subscribe-btn" onclick="initializePayment('enterprise', 4500000)">Choose
                Enterprise</button>
        </div>
    </div>




    <!-- Ad Services Section -->
    <div class="ad-services">
        <h2>Additional Advertising Services <span class="coming-soon">Coming Soon</span></h2>

        <div class="ad-service">
            <h3>Website Ads Boost</h3>
            <p>Promote Your Properties On Website</p>
            <button class="subscribe-btn" onclick="createAds()">Create Website Ads</button>
        </div>

        <div class="ad-service">
            <h3>Facebook Ads Boost</h3>
            <p>Promote Your Properties On Facebook</p>
            <button class="subscribe-btn" onclick="createAds()">Create Facebook Ads</button>
        </div>

        <div class="ad-service">
            <h3>Google Ads Promotion</h3>
            <p>Feature Your Properties In Google Search Results</p>
            <button class="subscribe-btn" onclick="createAds()">Create Google Ads</button>
        </div>
    </div>

    <script>

        (async () => {
            const base = '/component/loader'; // <-- set this to your actual folder (note leading slash)
            // add CSS once
            if (!document.querySelector('link[data-eh-loader-css]')) {
                const l = document.createElement('link');
                l.rel = 'stylesheet';
                l.href = base + '/loader.css';
                l.setAttribute('data-eh-loader-css', 'true');
                document.head.appendChild(l);
            }

            // optional: preload fragment to warm fetch
            try { await fetch(base + '/loader.html', { cache: 'no-store' }); } catch (e) { }

            // add loader.js and wait for it to load
            const s = document.createElement('script');
            s.src = base + '/loader.js';
            s.defer = true;
            s.setAttribute('data-eh-loader-js', 'true');

            s.onload = () => {
                if (window.Loader) {
                    // NOW it's safe to call Loader
                    Loader.show({ mode: 'fullscreen' });
                    // const section = document.getElementById('card'); // ensure position:relative
                    // Loader.show({ mode: 'inline', target: section });
                    // example hide after 1.8s (remove or call hide when work finishes)
                    // setTimeout(() => Loader.hide(), 1800);
                } else {
                    console.error('loader.js loaded but window.Loader not found.');
                }
            };

            s.onerror = () => console.error('Failed to load loader.js — check path:', s.src);
            document.body.appendChild(s);
        })();
        const auth = firebase.auth();
        const database = firebase.database();
        let email;
        let userId;
        let profiledata;
        document.addEventListener('DOMContentLoaded', () => {
            updateSubscriptionButtons();
        });
        // Check Authentication State
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                email = user.email;
                userId = user.uid;
                const [userSnap] = await Promise.all([
                    database.ref(`Users/${user.uid}`).once('value')
                ]);
                // const userSnap = database.ref(`Users/${user.uid}`).once('value')
                profiledata = userSnap.val() || {};



            }
        });
        console.log(email);

        let ClientIp;
        let UserAgent;

        function generateUUID() {
            // Creates unique event_id for each action
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        async function getClientIp() {
            try {
                const response = await fetch("https://api.ipify.org?format=json");
                const data = await response.json();
                console.log(data.ip);

                ClientIp = data.ip;
                return data.ip; // real public IP
            } catch (e) {
                console.error("Unable to get IP:", e);
                return null;
            }
        }

        function getUserAgent() {
            return navigator.userAgent;
        }

        function getFbp() {
            return document.cookie
                .split('; ')
                .find(row => row.startsWith('_fbp='))?.split('=')[1];
        }

        function getFbc() {
            return document.cookie
                .split('; ')
                .find(row => row.startsWith('_fbc='))?.split('=')[1];
        }

        function getSavedFbc() {

            // --- helpers ---
            function getCookie(name) {
                return document.cookie
                    .split("; ")
                    .find(row => row.startsWith(name + "="))
                    ?.split("=")[1] || null;
            }

            function setCookie(name, value, days = 90) {
                const expires = new Date(Date.now() + days * 86400 * 1000).toUTCString();
                document.cookie = `${name}=${value}; path=/; expires=${expires}; SameSite=Lax`;
            }

            // --- 1. Try get from cookie ---
            let fbc = getCookie("eagleshub_fbc");

            // --- 2. If cookie missing, try from localStorage ---
            if (!fbc) {
                try {
                    fbc = localStorage.getItem("eagleshub_fbc");
                } catch (e) {
                    // ignore storage errors
                }

                // --- 3. If found in localStorage, auto-repair cookie ---
                if (fbc) {
                    setCookie("eagleshub_fbc", fbc, 90); // restore cookie for 90 days
                }
            }

            // --- 4. If still missing, return fallback ---    git config --global user.name "suxcy1"    git config --global user.email "muhammedsadiq479@gmail.com"
            return fbc || "not_found";
        }


        // Send event to both Facebook Pixel (browser) and your server (CAPI)  git commit -m "fix facebook"

        async function trackEvent(eventName, userData = {}, customData = {}) {
            const eventId = generateUUID();
            const endpoint = 'https://engleshub.onrender.com/api/fb-events'; // <== change to your backend endpoint
            // const endpoint = 'http://locahost:4000/api/fb-events'; // <== change to your backend endpoint

            // 1️⃣ Fire browser event
            // fbq('track', eventName, {
            //     event_id: eventId,
            //     ...userData
            // });

            // 2️⃣ Send same event_id + user info to server
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_name: eventName,
                        event_id: eventId,
                        user_data: userData,
                        customData: customData,
                        client_user_agent: navigator.userAgent,
                        client_ip_address: '', // leave empty; server will extract IP
                        event_time: Math.floor(Date.now() / 1000),
                    })
                });

                if (!response.ok) throw new Error('Server failed');
                console.log(`[Facebook CAPI] Sent ${eventName} event successfully ✅`);
            } catch (err) {
                console.error('Error sending event to server:', err);
            }
        }

        // Paystack configuration
        //pk_test_3af7f6c37cdd5d6865ecf49f6bccff13cbb739fe
        //pk_live_fe63d06517c981e17bf9f098da5f469269d4ba2c
        const paystackPublicKey = 'pk_live_fe63d06517c981e17bf9f098da5f469269d4ba2c'; // Replace with your Paystack public key


        async function initializePayment(plan, amount) {
            if (plan === "trial" && amount === 0) {
                handlePaymentSuccess("trial", plan);
                return;
            }
            console.log(plan);
            console.log(amount);



            let amounts = 0
            let realAmount = 0
            if (plan === 'professional') {
                amounts = 1500000;
                realAmount = 15000
            } else if (plan === 'starter') {
                console.log("hewllo 1");
                amounts = 60000;
                realAmount = 6000;
            } else if (plan === 'business') {
                amounts = 2800000;
                realAmount = 28000
            } else if (plan === 'enterprise') {
                amounts = 6000000
                realAmount = 60000
            } 

            if (!plan == 'starter') {
                console.log("hewllo 2");
                
            }

            if (!amount) {
                amount = amounts
            } else {
                amount = amounts
            }
            console.log(plan)
            console.log(email);
            console.log(amount)
            console.log(amounts)
            const handler = PaystackPop.setup({
                key: paystackPublicKey,
                email: email, // Get from logged-in user
                amount: amount, // Amount in kobo
                currency: 'NGN',
                metadata: {
                    plan: plan,
                    features: getPlanFeatures(plan)
                },
                callback: function (response) {
                    (async () => {

                        // Payment successful - update Firebase here
                        const id = amounts;
                        const val = parseFloat(realAmount) || 0.0;
                        const cur = "NGN"

                        // fbq('track', 'Subscription', {
                        //     content_ids: [id],
                        //     content_email: email,
                        //     content_name: 'Manual Test Product',
                        //     contents: [{ id: id, email: content_email, item_price: val }],
                        //     value: val,
                        //     currency: cur
                        // });

                        await getClientIp();
                        UserAgent = getUserAgent();
                        console.log(UserAgent);
                        console.log(ClientIp);

                        const FB_FBP = getFbp();
                        // const FB_FBC = getFbc();
                        const FB_FBC = getSavedFbc();
                        console.log(FB_FBP);
                        console.log(FB_FBC);

                        console.log(profiledata);
                        const first = profiledata.details.firstName
                        const last = profiledata.details.lastName
                        const phone = profiledata.details.phone
                        const state = profiledata.address.state
                        const city = profiledata.address.city

                        console.log(first + last + phone + state + city);

                        const contentId = response.reference


                        await trackEvent('Subscribe', {
                            email: email,
                            firstName: first,
                            lastName: last,
                            phone: phone,
                            city: city,
                            state: state,
                            country: 'NG',
                            action_type: 'subscribe',
                            clientIpAddress: ClientIp,
                            clientUserAgent: UserAgent,
                            fbp: FB_FBP,
                            fbc: FB_FBC
                        }, {
                            contentName: plan,
                            contentId: contentId,
                            subscription_plan: plan,
                            value: amount,
                            currency: 'NGN'
                        }
                        );
                        handlePaymentSuccess(response, plan);
                    })();
                },
                onClose: function () {
                    alert('Payment closed');
                }
            });
            handler.openIframe();
        }

        function createAds() {

            fbq('track', 'createAds', { value: 2000.99, currency: 'NGN' });
            window.location.href = `ads-creation.html`;
        }

        function getPlanFeatures(plan) {
            const plans = {
                starter: ['1 Property Upload', 'No Social Media Ads'],
                profession: ['7 Property Uploads', '2 Website Ads (15 days)', '2 Social Media Ads'],
                business: ['15 Property Uploads', '5 Website Ads (15 days)', '5 Social Media Ads'],
                enterprise: ['Unlimited Uploads', '5 Website Ads', '5 Social Media Ads', "5 Google Ads (10 days)"]
            };
            return plans[plan] || [];
        }
        function formatExpiry(ts) {
            if (!ts) return '—';
            const d = (typeof ts === 'number') ? new Date(ts) : new Date(ts);
            if (isNaN(d)) return '—';
            // Example format: Sunday, Oct 26, 2025
            const opts = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            return d.toLocaleDateString(undefined, opts);
        }

        function capitalize(s) { return (s || '').toString().charAt(0).toUpperCase() + (s || '').toString().slice(1); }
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }


        function buildSubscriptionHTML(planName, startTs, expiryTs, txnId) {

            const plan = (planName).toLowerCase()
            const features = getPlanFeatures(plan);

            const started = startTs ? new Date(startTs).toLocaleString() : '';

            const expires = formatExpiry(expiryTs);

            return `
    <section class="engles-notif subscription-card" role="article" aria-label="Subscription confirmed">
      <div style="display:flex;align-items:center;gap:14px;">
        <div class="logo-badge" aria-hidden="true">EH</div>
        <div>
          <div class="plan-title">Subscription Confirmed — ${capitalize(planName)}</div>
          <div class="lead">Thank you — your subscription is now active.</div>
        </div>
      </div>

      <div class="body" style="margin-top:12px;">
        <p style="margin:0 0 8px;">
          Your <strong>${capitalize(planName)}</strong> package has been activated${started ? ` on ${started}` : ''}.
          Below are the benefits included with this plan:
        </p>

        <ul class="features" aria-live="polite">
          ${features.map(f => `<li>${escapeHtml(f)}</li>`).join('')}
        </ul>

        <div class="expiry">Package expires: <strong>${expires}</strong></div>

        <div class="cta">
          <a class="btn-small btn-sub" href="subscription.htm" role="button" aria-label="View subscription">Manage Subscription</a>
          <a class="btn-small btn-manage" href="complete-profile.html" role="button" aria-label="Complete profile">Complete Profile</a>
        </div>

        <p class="small" style="margin-top:10px;">
          Transaction ID: ${txnId || '—'}. For assistance, contact <a href="support.html">Support</a>.
        </p>
      </div>
    </section>
  `;
        }



        // Payment success handler - Add your Firebase update code here
        async function handlePaymentSuccess(paymentResponse, plan) {

            // One month in milliseconds
            const ONE_MONTH_MS = 30 * 24 * 60 * 60 * 1000;
            const ref = paymentResponse.reference

            const now = Date.now();
            const expire = now + ONE_MONTH_MS
            const plans = {
                reference: ref,
                plan: plan,
                start: now,

            }

            if (plan === "trial") {
                alert(`Payment successful!`);

                const ONE_MONTH_MS = 7 * 24 * 60 * 60 * 1000;
                const ref = paymentResponse.reference

                const nows = Date.now();
                const trialExpire = nows + ONE_MONTH_MS
                plans.expire = trialExpire;
            } else {
                plans.expire = expire;
            }

            const subNotiffication = buildSubscriptionHTML(plan, now, expire, ref)

            console.log(subNotiffication)
            await database.ref(`Users/${userId}/subscription`).update(plans);
            const notifRef = database.ref(`Users/${userId}/notifications`).push();
            await notifRef.set({
                content: subNotiffication,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'new'
            })
            alert(`Payment successful! Reference: ${paymentResponse.reference}`);


            sessionStorage.setItem("plan", plan)
            updateSubscriptionButtons();

            // 4. Show a toast/alert
            alert(`You are now on the ${plan.charAt(0).toUpperCase() + plan.slice(1)} plan!`);
        }

        function updateSubscriptionButtons() {
            const userPlan = (sessionStorage.getItem('plan') || 'starter').toLowerCase();
            const premiumGold = ['profession', 'business', 'enterprise'];



            document.querySelectorAll('.plan').forEach(card => {
                const plan = card.dataset.plan;
                const btn = card.querySelector('.subscribe-btn');

                // Reset default state
                btn.disabled = false;
                btn.style.opacity = '';
                btn.style.cursor = '';
                btn.onclick = () => initializePayment(plan, getPlanAmount(plan));

                if (userPlan) {
                    if (premiumGold.includes(userPlan) && plan === userPlan) {
                        // Premium & Gold: View Placonsole.log(userPlan);'free', 
                        btn.textContent = 'View Plan';
                        btn.onclick = () => {
                            window.location.href = `details.html?plan=${plan}`;
                        };
                    }
                    //  else {
                    //     // Free & Silver: Selected Plan (no action)
                    //     btn.textContent = 'Selected Plan';
                    //     btn.disabled = true;
                    //     btn.style.opacity = 0.6;
                    //     btn.style.cursor = 'not-allowed';
                    // }
                } else {
                    // Plans not yet chosen
                    btn.textContent = plan === 'free'
                        ? 'Start Free'
                        : `Choose ${plan.charAt(0).toUpperCase() + plan.slice(1)}`;

                    // if (plan === 'free') {
                    //     btn.textContent = 'View Plan';
                    //     btn.onclick = () => {
                    //         window.location.href = `details.html?plan=${plan}`;
                    //     };
                    // } else{
                    //     btn.textContent = `Choose ${plan.charAt(0).toUpperCase() + plan.slice(1)}`;
                    // }
                }
            });
        }

        function getPlanAmount(plan) {
            switch (plan) {
                case 'profession': return 1200000;
                case 'business': return 2000000;
                case 'enterprise': return 3500000;
                default: return 0;  // free
            }


        }
    </script>
</body>

</html>